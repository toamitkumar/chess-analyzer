{"ast":null,"code":"import { unselect, cancelMove, getKeyAtDomPos, getSnappedKeyAtDomPos, whitePov } from './board.js';\nimport { eventPosition, isRightButton } from './util.js';\nconst brushes = ['green', 'red', 'blue', 'yellow'];\nexport function start(state, e) {\n  // support one finger touch only\n  if (e.touches && e.touches.length > 1) return;\n  e.stopPropagation();\n  e.preventDefault();\n  e.ctrlKey ? unselect(state) : cancelMove(state);\n  const pos = eventPosition(e),\n    orig = getKeyAtDomPos(pos, whitePov(state), state.dom.bounds());\n  if (!orig) return;\n  state.drawable.current = {\n    orig,\n    pos,\n    brush: eventBrush(e),\n    snapToValidMove: state.drawable.defaultSnapToValidMove\n  };\n  processDraw(state);\n}\nexport function processDraw(state) {\n  requestAnimationFrame(() => {\n    const cur = state.drawable.current;\n    if (cur) {\n      const keyAtDomPos = getKeyAtDomPos(cur.pos, whitePov(state), state.dom.bounds());\n      if (!keyAtDomPos) {\n        cur.snapToValidMove = false;\n      }\n      const mouseSq = cur.snapToValidMove ? getSnappedKeyAtDomPos(cur.orig, cur.pos, whitePov(state), state.dom.bounds()) : keyAtDomPos;\n      if (mouseSq !== cur.mouseSq) {\n        cur.mouseSq = mouseSq;\n        cur.dest = mouseSq !== cur.orig ? mouseSq : undefined;\n        state.dom.redrawNow();\n      }\n      processDraw(state);\n    }\n  });\n}\nexport function move(state, e) {\n  if (state.drawable.current) state.drawable.current.pos = eventPosition(e);\n}\nexport function end(state) {\n  const cur = state.drawable.current;\n  if (cur) {\n    if (cur.mouseSq) addShape(state.drawable, cur);\n    cancel(state);\n  }\n}\nexport function cancel(state) {\n  if (state.drawable.current) {\n    state.drawable.current = undefined;\n    state.dom.redraw();\n  }\n}\nexport function clear(state) {\n  if (state.drawable.shapes.length) {\n    state.drawable.shapes = [];\n    state.dom.redraw();\n    onChange(state.drawable);\n  }\n}\nexport const sameEndpoints = (s1, s2) => s1.orig === s2.orig && s1.dest === s2.dest;\nexport const sameColor = (s1, s2) => s1.brush === s2.brush;\nfunction eventBrush(e) {\n  const modA = (e.shiftKey || e.ctrlKey) && isRightButton(e);\n  const modB = e.altKey || e.metaKey || e.getModifierState?.('AltGraph');\n  return brushes[(modA ? 1 : 0) + (modB ? 2 : 0)];\n}\nfunction addShape(drawable, cur) {\n  const similar = drawable.shapes.find(s => sameEndpoints(s, cur));\n  if (similar) drawable.shapes = drawable.shapes.filter(s => !sameEndpoints(s, cur));\n  if (!similar || !sameColor(similar, cur)) drawable.shapes.push({\n    orig: cur.orig,\n    dest: cur.dest,\n    brush: cur.brush\n  });\n  onChange(drawable);\n}\nfunction onChange(drawable) {\n  if (drawable.onChange) drawable.onChange(drawable.shapes);\n}\n//# sourceMappingURL=draw.js.map","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}