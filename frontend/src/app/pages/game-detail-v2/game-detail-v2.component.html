<app-layout>
  <!-- Page Header with Back Button -->
  <div class="flex items-center gap-4 px-4 py-4">
    <button
      (click)="goBack()"
      class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 hover:bg-accent hover:text-accent-foreground h-10 w-10">
      <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
      </svg>
    </button>
    <div class="flex-1">
      <h1 class="text-2xl sm:text-3xl font-bold text-foreground">Game Analysis</h1>
      <p class="text-sm text-muted-foreground">Review moves, accuracy, and engine evaluation</p>
    </div>
  </div>

  <div class="lichess-layout">
    <!-- Left Panel: Player Stats, Phase Analysis, Move Quality -->
    <div class="analysis-panel left-panel">
      <!-- Back to Games Button -->
      <button
        (click)="navigateTo('/games')"
        class="w-full mb-3 inline-flex items-center justify-center gap-2 rounded-lg border border-border bg-card px-4 py-2 text-sm font-medium text-muted-foreground hover:bg-accent hover:text-foreground transition-colors">
        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
        </svg>
        Back to Games
      </button>
      <!-- Player Stats -->
      <div class="rounded-xl border-2 border-border/30 bg-card/50 backdrop-blur-sm overflow-hidden mb-3">
        <div class="px-4 py-2 bg-gradient-to-r from-muted/50 to-transparent border-b border-border/30">
          <h3 class="text-sm font-semibold text-foreground tracking-wide">Player Stats</h3>
        </div>
        <div class="p-3 space-y-2">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-sm bg-gradient-to-br from-gray-100 to-gray-300 shadow-sm border border-gray-300"></div>
            <span class="flex-1 text-sm font-medium text-foreground truncate">{{ game?.white_player || 'White' }}</span>
            <div class="flex gap-1">
              <span class="px-2 py-0.5 rounded text-xs font-semibold bg-sky-500/20 text-sky-600" *ngIf="whiteStats.inaccuracies" title="Inaccuracies">{{ whiteStats.inaccuracies }}</span>
              <span class="px-2 py-0.5 rounded text-xs font-semibold bg-amber-500/20 text-amber-600" *ngIf="whiteStats.mistakes" title="Mistakes">{{ whiteStats.mistakes }}</span>
              <span class="px-2 py-0.5 rounded text-xs font-semibold bg-red-500/20 text-red-600" *ngIf="whiteStats.blunders" title="Blunders">{{ whiteStats.blunders }}</span>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 rounded-sm bg-gradient-to-br from-gray-700 to-gray-900 shadow-sm"></div>
            <span class="flex-1 text-sm font-medium text-foreground truncate">{{ game?.black_player || 'Black' }}</span>
            <div class="flex gap-1">
              <span class="px-2 py-0.5 rounded text-xs font-semibold bg-sky-500/20 text-sky-600" *ngIf="blackStats.inaccuracies" title="Inaccuracies">{{ blackStats.inaccuracies }}</span>
              <span class="px-2 py-0.5 rounded text-xs font-semibold bg-amber-500/20 text-amber-600" *ngIf="blackStats.mistakes" title="Mistakes">{{ blackStats.mistakes }}</span>
              <span class="px-2 py-0.5 rounded text-xs font-semibold bg-red-500/20 text-red-600" *ngIf="blackStats.blunders" title="Blunders">{{ blackStats.blunders }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Phase Analysis -->
      <div class="rounded-xl border-2 border-border/30 bg-card/50 backdrop-blur-sm overflow-hidden mb-3">
        <div class="px-4 py-2 bg-gradient-to-r from-muted/50 to-transparent border-b border-border/30">
          <h3 class="text-sm font-semibold text-foreground tracking-wide">Phase Analysis</h3>
        </div>
        <div class="p-3 space-y-1">
          <div class="flex justify-between items-center px-2 py-1.5 rounded-lg hover:bg-muted/50 cursor-pointer transition-colors" (click)="goToPhase('opening')">
            <span class="text-sm text-foreground">Opening</span>
            <span class="text-sm font-semibold text-success">{{ phaseStats.opening.accuracy }}%</span>
          </div>
          <div class="flex justify-between items-center px-2 py-1.5 rounded-lg hover:bg-muted/50 cursor-pointer transition-colors" (click)="goToPhase('middlegame')">
            <span class="text-sm text-foreground">Middlegame</span>
            <span class="text-sm font-semibold text-success">{{ phaseStats.middlegame.accuracy }}%</span>
          </div>
          <div class="flex justify-between items-center px-2 py-1.5 rounded-lg hover:bg-muted/50 cursor-pointer transition-colors" (click)="goToPhase('endgame')">
            <span class="text-sm text-foreground">Endgame</span>
            <span class="text-sm font-semibold text-success">{{ phaseStats.endgame.accuracy }}%</span>
          </div>
        </div>
      </div>

      <!-- Move Quality Distribution -->
      <div class="rounded-xl border-2 border-border/30 bg-card/50 backdrop-blur-sm overflow-hidden">
        <div class="px-4 py-2 bg-gradient-to-r from-muted/50 to-transparent border-b border-border/30">
          <h3 class="text-sm font-semibold text-foreground tracking-wide">Move Quality</h3>
        </div>
        <div class="p-3">
          <div class="grid grid-cols-[1fr_28px_28px] gap-1 text-xs">
            <div class="text-muted-foreground font-medium"></div>
            <div class="text-center text-muted-foreground font-medium">W</div>
            <div class="text-center text-muted-foreground font-medium">B</div>
            
            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-700"></span><span class="text-foreground">Best</span></div>
            <div class="text-center text-foreground">{{ moveQuality.white.best }}</div>
            <div class="text-center text-foreground">{{ moveQuality.black.best }}</div>
            
            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span><span class="text-foreground">Excellent</span></div>
            <div class="text-center text-foreground">{{ moveQuality.white.excellent }}</div>
            <div class="text-center text-foreground">{{ moveQuality.black.excellent }}</div>
            
            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span><span class="text-foreground">Good</span></div>
            <div class="text-center text-foreground">{{ moveQuality.white.good }}</div>
            <div class="text-center text-foreground">{{ moveQuality.black.good }}</div>
            
            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-sky-500"></span><span class="text-foreground">Inaccuracy</span></div>
            <div class="text-center text-foreground">{{ moveQuality.white.inaccuracy }}</div>
            <div class="text-center text-foreground">{{ moveQuality.black.inaccuracy }}</div>
            
            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-500"></span><span class="text-foreground">Mistake</span></div>
            <div class="text-center text-foreground">{{ moveQuality.white.mistake }}</div>
            <div class="text-center text-foreground">{{ moveQuality.black.mistake }}</div>
            
            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500"></span><span class="text-foreground">Blunder</span></div>
            <div class="text-center text-foreground">{{ moveQuality.white.blunder }}</div>
            <div class="text-center text-foreground">{{ moveQuality.black.blunder }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Center: Chess Board with Eval Bar -->
    <div class="board-section">
      <div class="board-with-eval">
        <div class="eval-bar-vertical" [class.flipped]="orientation === 'black'">
          <div class="eval-bar-white" [style.height.%]="orientation === 'white' ? getWhiteWinPercent() : 100 - getWhiteWinPercent()"></div>
          <div class="eval-bar-black" [style.height.%]="orientation === 'white' ? 100 - getWhiteWinPercent() : getWhiteWinPercent()"></div>
          <span class="eval-text" [class.eval-white]="currentEval >= 0" [class.eval-black]="currentEval < 0">
            {{ formatEval(currentEval) }}
          </span>
        </div>
        <div class="board-wrapper">
          <div #chessboard class="cg-wrap"></div>
        </div>
      </div>
      <!-- Tabs below board -->
      <div class="board-tabs">
        <div class="tabs-header">
          <button class="tab-btn" [class.active]="activeTab === 'analysis'" (click)="activeTab = 'analysis'">Computer analysis</button>
          <button class="tab-btn" [class.active]="activeTab === 'share'" (click)="activeTab = 'share'">Share & export</button>
        </div>
        <div class="tabs-content">
          <div *ngIf="activeTab === 'analysis'" class="tab-panel">
            <div class="eval-graph-container" *ngIf="moves.length > 0">
              <svg class="eval-graph" [attr.viewBox]="'0 0 ' + graphWidth + ' ' + graphHeight">
                <rect x="0" y="0" [attr.width]="graphWidth" [attr.height]="graphHeight/2" fill="#fff"/>
                <rect x="0" [attr.y]="graphHeight/2" [attr.width]="graphWidth" [attr.height]="graphHeight/2" fill="#888"/>
                <line x1="0" [attr.y1]="graphHeight/2" [attr.x1]="graphWidth" [attr.y2]="graphHeight/2" stroke="#666" stroke-width="1"/>
                <path [attr.d]="getEvalPath()" fill="rgba(255,255,255,0.8)" stroke="#333" stroke-width="1.5"/>
                <ng-container *ngFor="let move of moves; let i = index">
                  <circle *ngIf="move.is_blunder" [attr.cx]="getGraphX(i)" [attr.cy]="getGraphY(move.evaluation)" r="5" fill="#db3434" class="eval-dot" (click)="goToMove(i)"/>
                  <circle *ngIf="move.is_mistake && !move.is_blunder" [attr.cx]="getGraphX(i)" [attr.cy]="getGraphY(move.evaluation)" r="5" fill="#e69f00" class="eval-dot" (click)="goToMove(i)"/>
                  <circle *ngIf="move.is_inaccuracy && !move.is_mistake && !move.is_blunder" [attr.cx]="getGraphX(i)" [attr.cy]="getGraphY(move.evaluation)" r="4" fill="#56b4e9" class="eval-dot" (click)="goToMove(i)"/>
                </ng-container>
                <line *ngIf="currentMoveIndex >= 0" [attr.x1]="getGraphX(currentMoveIndex)" y1="0" [attr.x2]="getGraphX(currentMoveIndex)" [attr.y2]="graphHeight" stroke="#3893e8" stroke-width="2" opacity="0.7"/>
              </svg>
            </div>
          </div>
          <div *ngIf="activeTab === 'share'" class="tab-panel">
            <div class="share-section">
              <strong>FEN</strong>
              <div class="share-row">
                <input type="text" readonly [value]="currentFen" class="share-input" />
                <button class="copy-btn" (click)="copyToClipboard(currentFen, 'fen')" title="Copy">{{ copiedField === 'fen' ? 'âœ“' : 'ðŸ“‹' }}</button>
              </div>
            </div>
            <div class="share-section">
              <strong>Share</strong>
              <div class="share-row">
                <input type="text" readonly [value]="getShareUrl()" class="share-input" />
                <button class="copy-btn" (click)="copyToClipboard(getShareUrl(), 'url')" title="Copy">{{ copiedField === 'url' ? 'âœ“' : 'ðŸ“‹' }}</button>
              </div>
            </div>
            <div class="share-section" *ngIf="moves.length">
              <strong>PGN</strong>
              <div class="share-row">
                <input type="text" readonly [value]="getPgn()" class="share-input" />
                <button class="copy-btn" (click)="copyToClipboard(getPgn(), 'pgn')" title="Copy">{{ copiedField === 'pgn' ? 'âœ“' : 'ðŸ“‹' }}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel: Move List with Controls at Bottom -->
    <div class="analysis-panel right-panel">
      <div class="opening-bar" *ngIf="game?.opening_name">{{ game.opening_name }}</div>
      <div class="moves-container" #movesContainer>
        <div class="moves-list">
          <ng-container *ngFor="let pair of movePairs">
            <span class="move-index">{{ pair.moveNumber }}</span>
            <span class="move" [class.current]="currentMoveIndex === pair.whiteIndex" (click)="pair.white && goToMove(pair.whiteIndex)">
              <span class="san">{{ pair.white?.move }}</span><span class="nag blunder" *ngIf="pair.white?.is_blunder" title="Blunder">??</span><span class="nag mistake" *ngIf="pair.white?.is_mistake && !pair.white?.is_blunder" title="Mistake">?</span><span class="nag inaccuracy" *ngIf="pair.white?.is_inaccuracy && !pair.white?.is_mistake && !pair.white?.is_blunder" title="Inaccuracy">?!</span>
              <span class="eval">{{ formatInlineEval(pair.white?.evaluation) }}</span>
            </span>
            <div class="annotation" *ngIf="pair.white && (pair.white.is_blunder || pair.white.is_mistake || pair.white.is_inaccuracy)">
              <span class="annotation-text">{{ getAnnotationLabel(pair.white) }} {{ pair.white.best_move }} was best.</span>
              <span class="best-line" *ngIf="getBestLine(pair.white) as line">
                <span class="line-move" [class.current]="isAltLineCurrent(pair.whiteIndex, i)" *ngFor="let m of line; let i = index" (click)="playBestLine(pair.whiteIndex, i, $event)">{{ formatLineMove(pair.moveNumber, i, true, m) }}</span>
              </span>
            </div>
            <span class="move" *ngIf="pair.black" [class.current]="currentMoveIndex === pair.blackIndex" (click)="goToMove(pair.blackIndex)">
              <span class="san">{{ pair.black?.move }}</span><span class="nag blunder" *ngIf="pair.black?.is_blunder" title="Blunder">??</span><span class="nag mistake" *ngIf="pair.black?.is_mistake && !pair.black?.is_blunder" title="Mistake">?</span><span class="nag inaccuracy" *ngIf="pair.black?.is_inaccuracy && !pair.black?.is_mistake && !pair.black?.is_blunder" title="Inaccuracy">?!</span>
              <span class="eval">{{ formatInlineEval(pair.black?.evaluation) }}</span>
            </span>
            <div class="annotation" *ngIf="pair.black && (pair.black.is_blunder || pair.black.is_mistake || pair.black.is_inaccuracy)">
              <span class="annotation-text">{{ getAnnotationLabel(pair.black) }} {{ pair.black.best_move }} was best.</span>
              <span class="best-line" *ngIf="getBestLine(pair.black) as line">
                <span class="line-move" [class.current]="isAltLineCurrent(pair.blackIndex, i)" *ngFor="let m of line; let i = index" (click)="playBestLine(pair.blackIndex, i, $event)">{{ formatLineMove(pair.moveNumber, i, false, m) }}</span>
              </span>
            </div>
          </ng-container>
          <span class="result" *ngIf="game?.result">{{ game.result }}</span>
        </div>
      </div>
      <div class="board-controls">
        <button class="ctrl-btn hover:bg-accent hover:text-accent-foreground" (click)="goToStart()" title="Start"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" transform="rotate(180 12 12)"/></svg></button>
        <button class="ctrl-btn hover:bg-accent hover:text-accent-foreground" (click)="goToPrevious()" title="Previous"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
        <button class="ctrl-btn hover:bg-accent hover:text-accent-foreground" (click)="flipBoard()" title="Flip"><svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
        <button class="ctrl-btn hover:bg-accent hover:text-accent-foreground" (click)="goToNext()" title="Next"><svg viewBox="0 0 24 24"><path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/></svg></button>
        <button class="ctrl-btn hover:bg-accent hover:text-accent-foreground" (click)="goToEnd()" title="End"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
      </div>
    </div>
  </div>
</app-layout>
